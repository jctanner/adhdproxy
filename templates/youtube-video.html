{% extends "base.html" %}

{% block title %}{{video.title}} - ADHD Proxy{% endblock %}
{% block nav_youtube %}active{% endblock %}

{% block extra_head %}
<style>
.video-container {
    position: relative;
    display: inline-block;
    width: 100%;
    max-width: 960px;
    background: #000;
}

video {
    width: 100%;
    height: auto;
    position: relative;
    display: block;
    z-index: 1;
}

#mosaicCanvas {
    position: absolute;
    top: 0;
    left: 0;
    z-index: 2;
    pointer-events: none;
    width: 100%;
}

/* Make controls always show */
video::-webkit-media-controls {
    z-index: 3 !important;
    position: relative;
}

video::-webkit-media-controls-panel {
    z-index: 3 !important;
}
</style>
{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
    <div>
        <h1 style="margin-bottom: 10px;">{{video.title}}</h1>
        {% if video.uploader %}
        <p style="color: #666; font-size: 0.95em; margin: 0;">
            By <a href="/youtube/channel/{{ video.channel_id }}">{{ video.uploader }}</a>
        </p>
        {% endif %}
    </div>
    <div style="display: flex; gap: 10px;">
        {% if is_favorited %}
        <form method="POST" action="/favorite/remove" style="margin: 0;">
            <input type="hidden" name="type" value="video">
            <input type="hidden" name="id" value="{{ video.id }}">
            <input type="hidden" name="return_url" value="/youtube?video={{ video.id }}">
            <button type="submit" style="background: #e74c3c; white-space: nowrap;">‚òÖ Remove from Favorites</button>
        </form>
        {% else %}
        <form method="POST" action="/favorite/add" style="margin: 0;">
            <input type="hidden" name="type" value="video">
            <input type="hidden" name="id" value="{{ video.id }}">
            <input type="hidden" name="return_url" value="/youtube?video={{ video.id }}">
            <button type="submit" style="background: #f39c12; white-space: nowrap;">‚òÜ Add to Favorites</button>
        </form>
        {% endif %}
        <form method="POST" action="/delete/video" style="margin: 0;" onsubmit="return confirm('Are you sure you want to delete this video from cache? Downloaded files will be removed.');">
            <input type="hidden" name="id" value="{{ video.id }}">
            <input type="hidden" name="return_url" value="/youtube">
            <button type="submit" style="background: #95a5a6; white-space: nowrap;">üóë Delete from Cache</button>
        </form>
    </div>
</div>

{% if videofile != None %}
"{{ videofile }}"
<br>
<div class="video-container">
    <canvas id="mosaicCanvas" width="640" height="320" style="position: absolute; top: 0; left: 0; display: none; pointer-events: none;"></canvas>
    <video id="videoPlayer" width="640" height="360" controls {% if video.thumbnail %}poster="{{video.thumbnail}}"{% endif %}>
      <source src="/files/youtube/{{video.id}}/{{videofile}}">
    </video>
</div>
<br>
<button onclick="toggleThumbnail()" style="padding: 5px 10px; margin: 5px 0;">
    <span id="toggleText">Show Original Thumbnail</span>
</button>
<br><br>

<script>
var isFiltered = true;
var video = document.getElementById('videoPlayer');
var canvas = document.getElementById('mosaicCanvas');
var ctx = canvas.getContext('2d');
var mosaicMargin = 40; // leave room for controls

function syncCanvasSize() {
    var displayWidth = video.clientWidth || video.videoWidth || 640;
    var displayHeight = video.clientHeight || video.videoHeight || 360;
    var mosaicHeight = Math.max(displayHeight - mosaicMargin, Math.floor(displayHeight * 0.85));

    canvas.width = displayWidth;
    canvas.height = mosaicHeight;
    canvas.style.width = displayWidth + 'px';
    canvas.style.height = mosaicHeight + 'px';
}

// Create mosaic effect on thumbnail
{% if video.thumbnail %}
var thumbnail = new Image();
thumbnail.crossOrigin = "anonymous";
thumbnail.src = "{{video.thumbnail}}";
thumbnail.onload = function() {
    applyMosaicFilter();
};
{% endif %}

function applyMosaicFilter() {
    syncCanvasSize();
    var blockSize = 20; // Size of mosaic blocks
    var mosaicWidth = canvas.width;
    var mosaicHeight = canvas.height;

    // Draw image scaled down to leave room for controls
    var smallWidth = Math.max(1, Math.ceil(mosaicWidth / blockSize));
    var smallHeight = Math.max(1, Math.ceil(mosaicHeight / blockSize));

    // Create temporary small canvas
    var tempCanvas = document.createElement('canvas');
    tempCanvas.width = smallWidth;
    tempCanvas.height = smallHeight;
    var tempCtx = tempCanvas.getContext('2d');

    // Draw thumbnail scaled down to mosaic dimensions
    tempCtx.drawImage(thumbnail, 0, 0, smallWidth, smallHeight);

    // Get pixel data and convert to grayscale
    var imageData = tempCtx.getImageData(0, 0, smallWidth, smallHeight);
    var pixels = imageData.data;

    for (var i = 0; i < pixels.length; i += 4) {
        var gray = pixels[i] * 0.3 + pixels[i + 1] * 0.59 + pixels[i + 2] * 0.11;
        pixels[i] = pixels[i + 1] = pixels[i + 2] = gray;
    }

    tempCtx.putImageData(imageData, 0, 0);

    // Draw scaled back up with pixelation while keeping controls visible
    ctx.imageSmoothingEnabled = false;
    ctx.drawImage(tempCanvas, 0, 0, mosaicWidth, mosaicHeight);

    // Show mosaic by default
    canvas.style.display = 'block';
    video.removeAttribute('poster');  // Remove poster so mosaic shows instead
}

function toggleThumbnail() {
    var toggleText = document.getElementById('toggleText');

    if (isFiltered) {
        canvas.style.display = 'none';
        video.setAttribute('poster', '{{video.thumbnail}}');
        toggleText.textContent = 'Hide Original Thumbnail';
        isFiltered = false;
    } else {
        canvas.style.display = 'block';
        video.removeAttribute('poster');
        toggleText.textContent = 'Show Original Thumbnail';
        isFiltered = true;
    }
}

// Don't auto-hide canvas on play - let user manually toggle
// (For audio-only files, we want to keep showing the mosaic during playback)
window.addEventListener('resize', function() {
    if (canvas.style.display !== 'none') {
        applyMosaicFilter();
    } else {
        syncCanvasSize();
    }
});

// Ensure sizing is correct on initial load
document.addEventListener('DOMContentLoaded', syncCanvasSize);
</script>
{% endif %}

<h2>Quick Actions</h2>
<div style="margin: 20px 0;">
    {% set best_audio = namespace(format=none, quality=0) %}
    {% set best_video = namespace(format=none, quality=0) %}

    {% for format in video.formats %}
        {# Find best audio-only format (highest abr) #}
        {% if format.vcodec == "none" and format.acodec != "none" and format.abr %}
            {% if format.abr > best_audio.quality %}
                {% set best_audio.format = format %}
                {% set best_audio.quality = format.abr %}
            {% endif %}
        {% endif %}

        {# Find best video format (highest height, video-only or combined) #}
        {% if format.vcodec != "none" and format.height %}
            {% if format.height > best_video.quality %}
                {% set best_video.format = format %}
                {% set best_video.quality = format.height %}
            {% endif %}
        {% endif %}
    {% endfor %}

    {% if best_audio.format %}
    <a href="/youtube?video={{video.id}}&format={{best_audio.format.format_id}}" style="display: inline-block; padding: 10px 20px; background: #4CAF50; color: white; text-decoration: none; margin-right: 10px;">
        <strong>LISTEN</strong><br>
        <span style="font-size: 0.9em;">
            {{ best_audio.format.format_note }} - {{ best_audio.format.ext }}
            {% if best_audio.format.abr %}
                - {{ "%.0f"|format(best_audio.format.abr) }}kbps
            {% endif %}
            {% if best_audio.format.filesize %}
                - {% if best_audio.format.filesize > 1048576 %}{{ "%.1f"|format(best_audio.format.filesize / 1048576) }} MB{% else %}{{ "%.1f"|format(best_audio.format.filesize / 1024) }} KB{% endif %}
            {% elif best_audio.format.filesize_approx %}
                - ~{% if best_audio.format.filesize_approx > 1048576 %}{{ "%.1f"|format(best_audio.format.filesize_approx / 1048576) }} MB{% else %}{{ "%.1f"|format(best_audio.format.filesize_approx / 1024) }} KB{% endif %}
            {% endif %}
        </span>
    </a>
    {% endif %}

    {% if best_video.format %}
    <a href="/youtube?video={{video.id}}&format={{best_video.format.format_id}}" style="display: inline-block; padding: 10px 20px; background: #2196F3; color: white; text-decoration: none;">
        <strong>WATCH</strong><br>
        <span style="font-size: 0.9em;">
            {{ best_video.format.height }}p - {{ best_video.format.ext }}
            {% if best_video.format.filesize %}
                - {% if best_video.format.filesize > 1073741824 %}{{ "%.1f"|format(best_video.format.filesize / 1073741824) }} GB{% elif best_video.format.filesize > 1048576 %}{{ "%.1f"|format(best_video.format.filesize / 1048576) }} MB{% else %}{{ "%.1f"|format(best_video.format.filesize / 1024) }} KB{% endif %}
            {% elif best_video.format.filesize_approx %}
                - ~{% if best_video.format.filesize_approx > 1073741824 %}{{ "%.1f"|format(best_video.format.filesize_approx / 1073741824) }} GB{% elif best_video.format.filesize_approx > 1048576 %}{{ "%.1f"|format(best_video.format.filesize_approx / 1048576) }} MB{% else %}{{ "%.1f"|format(best_video.format.filesize_approx / 1024) }} KB{% endif %}
            {% endif %}
        </span>
    </a>
    {% endif %}
</div>

{% if video.upload_date %}
<p style="color: #666; font-size: 0.95em; margin-top: 20px;">
    Uploaded: {{ video.upload_date[:4] }}-{{ video.upload_date[4:6] }}-{{ video.upload_date[6:8] }}
</p>
{% endif %}

{% if video.description %}
<div style="background: #f5f5f5; padding: 10px; margin: 10px 0; border-left: 3px solid #ccc;">
    <strong>Description:</strong>
    <pre style="white-space: pre-wrap; font-family: inherit; margin: 5px 0 0 0;">{{ video.description }}</pre>
</div>
{% endif %}

<h3>Transcript</h3>

{% if transcript_status == 'success' %}
<div style="padding: 10px; margin-bottom: 15px; background: #d4edda; border-left: 3px solid #28a745; color: #155724;">
    Transcript downloaded successfully!
</div>
{% elif transcript_status == 'unavailable' %}
<div style="padding: 10px; margin-bottom: 15px; background: #fff3cd; border-left: 3px solid #ffc107; color: #856404;">
    No transcript available for this video.
</div>
{% elif transcript_status == 'error' %}
<div style="padding: 10px; margin-bottom: 15px; background: #f8d7da; border-left: 3px solid #dc3545; color: #721c24;">
    Error downloading transcript. Please try again.
</div>
{% endif %}

{% if has_transcript %}
<div style="margin-bottom: 10px;">
    <a href="/transcript/download/{{ video.id }}" style="display: inline-block; padding: 8px 16px; background: #27ae60; color: white; text-decoration: none; border-radius: 3px;">
        üíæ Download Transcript
    </a>
</div>
<div style="background: #f9f9f9; padding: 15px; margin: 10px 0; border-left: 3px solid #3498db; max-height: 400px; overflow-y: auto;">
    <pre style="white-space: pre-wrap; font-family: inherit; margin: 0; line-height: 1.6;">{{ transcript }}</pre>
</div>
{% else %}
<form method="POST" action="/transcript/fetch" style="margin: 10px 0;">
    <input type="hidden" name="id" value="{{ video.id }}">
    <input type="hidden" name="return_url" value="/youtube?video={{ video.id }}">
    <button type="submit" style="background: #9b59b6; color: white;">üìù Fetch Transcript</button>
</form>
<p style="color: #666; font-size: 0.9em; font-style: italic;">Click the button above to download the transcript for this video.</p>
{% endif %}

<h3>All Formats</h3>
<table width="90%">
    <tr>
        <th>Type</th>
        <th>Quality</th>
        <th>Format</th>
        <th>Size</th>
        <th>Action</th>
    </tr>
{% for format in video.formats %}
    {% if format.audio_ext != "none" or format.video_ext != "none" %}
    {% set is_best_audio = best_audio.format and format.format_id == best_audio.format.format_id %}
    {% set is_best_video = best_video.format and format.format_id == best_video.format.format_id %}
    <tr {% if is_best_audio %}style="background-color: #c8e6c9;"{% elif is_best_video %}style="background-color: #bbdefb;"{% endif %}>
        <td>
            {% if format.vcodec == "none" and format.acodec != "none" %}
                Audio Only
            {% elif format.acodec == "none" and format.vcodec != "none" %}
                Video Only
            {% elif format.vcodec != "none" and format.acodec != "none" %}
                Video + Audio
            {% else %}
                Unknown
            {% endif %}
        </td>
        <td>
            {% if format.height %}
                {{ format.height }}p
            {% elif format.abr %}
                {{ format.abr }}kbps
            {% else %}
                N/A
            {% endif %}
        </td>
        <td>{{ format.format_note or format.format_id }} ({{ format.ext }})</td>
        <td>
            {% if format.filesize %}
                {% if format.filesize > 1073741824 %}
                    {{ "%.1f"|format(format.filesize / 1073741824) }} GB
                {% elif format.filesize > 1048576 %}
                    {{ "%.1f"|format(format.filesize / 1048576) }} MB
                {% else %}
                    {{ "%.1f"|format(format.filesize / 1024) }} KB
                {% endif %}
            {% elif format.filesize_approx %}
                ~{% if format.filesize_approx > 1073741824 %}
                    {{ "%.1f"|format(format.filesize_approx / 1073741824) }} GB
                {% elif format.filesize_approx > 1048576 %}
                    {{ "%.1f"|format(format.filesize_approx / 1048576) }} MB
                {% else %}
                    {{ "%.1f"|format(format.filesize_approx / 1024) }} KB
                {% endif %}
            {% else %}
                ?
            {% endif %}
        </td>
        <td><a href="/youtube?video={{video.id}}&format={{format.format_id}}">download</a></td>
    </tr>
    {% endif %}
{% endfor %}
</table>

{% endblock %}
